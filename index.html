<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Club Signup</title>
  <style>
    :root { --bg:#0b0c0f; --card:#14171c; --text:#f5f7fa; --muted:#9aa3ad; --accent:#52F756; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap { max-width:720px; margin:40px auto; padding:20px; }
    h1{ font-size:28px; margin:0 0 8px }
    .sub{ color:var(--muted); margin:0 0 24px }
    .grid{ display:grid; gap:12px }
    .card{ background:var(--card); border:1px solid #22272e; border-radius:12px; padding:14px 16px; display:flex; align-items:center; justify-content:space-between }
    .left{ display:flex; flex-direction:column; gap:6px }
    .slot{ font-weight:700 }
    .meta{ font-size:13px; color:var(--muted) }
    button{ border:none; padding:10px 14px; border-radius:10px; background:var(--accent); color:#031b06; font-weight:700; cursor:pointer }
    button[disabled]{ opacity:.45; cursor:not-allowed }
    .names{ font-size:14px }
    .footer{ margin-top:18px; color:var(--muted); font-size:13px }
    .toast{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#1d2229; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #2a313a; display:none }
    a{ color:var(--accent); text-decoration:none }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>English Club Signup</h1>
    <p class="sub">Week: <span id="weekLabel">…</span> · 5 seats per slot</p>

    <div id="grid" class="grid"></div>

    <p class="footer">Having trouble? Ping the organizer in Slack. Data is stored in Google Sheets for this week only.</p>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ======= CONFIG =======
    const API_URL = "https://script.google.com/macros/s/AKfycbwONW92dwRIUeXmwUT1CVrni6Hlf6MAjTE0qz60d7bDUT6yKfPNXtBw8xUdkM_AvrAF/exec"; // Sheety or Apps Script Web App URL
    const SLOTS = [
      { id:"mon_9_10", label:"Mon 9–10" },
      { id:"tue_12_1", label:"Tue 12–1" },
      { id:"wed_12_1", label:"Wed 12–1" },
      { id:"thu_12_1", label:"Thu 12–1" }
    ];
    const CAP = 5;

    // ======= UTIL: ISO week string "YYYY-Www" =======
    function getISOWeekString(d=new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = (date.getUTCDay() + 6) % 7; // Mon=0
      date.setUTCDate(date.getUTCDate() - dayNum + 3);
      const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
      const week = 1 + Math.round(((date - firstThursday)/86400000 - 3 + ((firstThursday.getUTCDay()+6)%7))/7);
      return `${date.getUTCFullYear()}-W${String(week).padStart(2,"0")}`;
    }
    const WEEK = getISOWeekString();
    document.getElementById("weekLabel").textContent = WEEK;

    const grid = document.getElementById("grid");
    const toast = document.getElementById("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 1600);
    }

    async function fetchRows(){
      const res = await fetch(API_URL, { cache:"no-store" });
      return res.json(); // expects array of {timestamp, week, slot, name}
    }

    function namesLine(list){
      return list.map(p => p.name).join(", ") || "—";
    }

    function slotPeople(rows, slotLabel){
      return rows.filter(r => r.week === WEEK && r.slot === slotLabel);
    }

    function cardTemplate(slotLabel, count, names, full){
      const btn = full ? `<button disabled>Full</button>` : `<button data-slot="${slotLabel}">Join</button>`;
      return `
        <div class="card">
          <div class="left">
            <div class="slot">${slotLabel}</div>
            <div class="meta">Seats: ${count}/${CAP}</div>
            <div class="names">${names}</div>
          </div>
          ${btn}
        </div>
      `;
    }

    async function render(){
      const rows = await fetchRows();
      grid.innerHTML = "";
      SLOTS.forEach(s => {
        const people = slotPeople(rows, s.label);
        const count = people.length;
        const full = count >= CAP;
        grid.insertAdjacentHTML("beforeend", cardTemplate(s.label, count, namesLine(people), full));
      });
      grid.querySelectorAll("button[data-slot]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const slot = btn.getAttribute("data-slot");
          const name = prompt("Enter your name (Slack display name):");
          if(!name) return;
          btn.disabled = true;
          try{
            const resp = await fetch(API_URL, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ week: WEEK, slot: slot, name: name })
            });
            if(!resp.ok){
              showToast("Signup failed. Try again.");
              btn.disabled = false;
              return;
            }
            showToast("Signed up!");
            await render(); // refresh
          }catch(e){
            btn.disabled = false;
            showToast("Network error.");
          }
        });
      });
    }

    render();
  </script>
</body>
</html>